<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https://firestore.googleapis.com https://firebase.googleapis.com; frame-ancestors 'none'">
    <title>Q&A Generator</title>
    <link rel="icon" type="image/x-icon" href="review.ico">
    <link rel="stylesheet" href="styles.css">
    <!-- JSZipåº“ -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script> -->
    <!-- JS7zåº“ -->
    <script src="js7z/js7z.js"></script>
</head>
<body>
    <!-- Debug Status Display -->
    <div id="debugStatus" style="position: fixed; top: 0; left: 0; right: 0; background: #ffeb3b; color: #000; padding: 5px; text-align: center; z-index: 9999; font-size: 12px; border-bottom: 2px solid #ff5722;">
        <strong>DEBUG MODE:</strong> 
        <span id="firebaseStatus">Firebase: Loading...</span> | 
        <span id="clientStatus">Client: Not loaded</span> |
        <button onclick="testBasicFunctionality()" style="margin-left: 10px; font-size: 11px;">Test Now</button>
        <button onclick="document.getElementById('debugStatus').style.display='none'" style="margin-left: 10px; font-size: 11px;">Hide</button>
    </div>
    
    <!-- Login Interface -->
    <div id="loginInterface" class="interface">
        <div class="login-box">
            <h1>Q&A Generator</h1>
            <p>Enter your name to continue:</p>
                <input type="text" id="userName" placeholder="Enter your username" required>
                <!-- NOT checked the duplicate username yet -->
            <button onclick="login()">Login</button>
        </div>
    </div>

    <!-- Owner Dashboard -->
    <div id="ownerDashboard" class="interface" style="display: none;">
        <div class="header">
            <h1>Owner Dashboard</h1>
            <div class="user-info">
                <span id="ownerName"></span>
                <button onclick="logout()" class="logout-btn">Logout</button>
            </div>
        </div>
        
        <div class="owner-controls">
            <!-- æ–°å»ºæŒ‰é’® -->
            <div class="new-quiz-section">
                <button onclick="showUploadModal()" class="new-btn">æ–°å»ºQuiz</button>
            </div>
            
            <!-- Quizç®¡ç†åŒºåŸŸ -->
            <div class="dashboard-section">
                <h3>Quiz Management</h3>
                <button onclick="showUploadModal()" class="upload-btn">Upload New Quiz</button>
                <button onclick="testFirebaseDB()" class="test-btn" style="background-color: #007bff; margin-left: 10px;">Test Firebase DB</button>
                <div id="quizList"></div>
            </div>
            
            <!-- Firebase Test Results -->
            <div id="firebaseTestResults" class="firebase-test-section" style="display: none;">
                <h3>Firebase DB Test Results</h3>
                <div id="testOutput" class="test-output"></div>
            </div>
            
            <!-- Sessionç®¡ç† -->
            <div id="sessionManagement" class="session-management" style="display: none;">
                <h3>Sessionç®¡ç†</h3>
                <div id="activeSessionInfo" class="session-info">
                    <h4>å½“å‰æ´»è·ƒSession</h4>
                    <div id="sessionDetails"></div>
                    <button onclick="endSession()" class="end-session-btn">ç»“æŸSession</button>
                </div>
            </div>
            
            <!-- å®æ—¶ç›‘æ§ -->
            <div class="real-time-monitoring">
                <h3>å®æ—¶ç›‘æ§</h3>
                <div class="monitoring-controls">
                    <button onclick="refreshMonitoring()" class="refresh-btn">åˆ·æ–°</button>
                    <span id="lastUpdateTime"></span>
                </div>
                <div id="realTimeResults"></div>
            </div>
            
            <!-- Ownerç®¡ç† (ä»…ç®¡ç†å‘˜å¯è§) -->
            <div id="ownerManagement" class="owner-management" style="display: none;">
                <h3>Ownerç®¡ç†</h3>
                <div class="owner-stats">
                    <div id="ownerStats"></div>
                </div>
                <div class="owner-list">
                    <h4>Owneråˆ—è¡¨</h4>
                    <div id="ownerList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Client Interface -->
    <div id="clientInterface" class="interface" style="display: none;">
        <div class="header">
            <h1 id="clientQuizTitle"></h1>
            <div class="user-info">
                <span id="clientName"></span>
                <span id="clientScore" class="score-display" style="display: none;"></span>
                <button onclick="logout()" class="logout-btn">Logout</button>
            </div>
        </div>
        
        <div id="quizContainer" class="quiz-container">
            <div class="quiz-header">
                <h2 id="quizTitle"></h2>
            </div>
            
            <div id="questionsContainer"></div>
            
            <div class="submit-section">
                <button onclick="submitQuiz()" class="submit-btn">æäº¤Quiz</button>
            </div>
        </div>
    </div>

    <!-- 404 Interface -->
    <div id="notFoundInterface" class="interface" style="display: none;">
        <div class="not-found">
            <h1>æµ‹è¯•æœªå‡†å¤‡å¥½</h1>
            <p>æ‚¨å·²æˆåŠŸç™»å½•ï¼Œä½†Ownerè¿˜æ²¡æœ‰å‡†å¤‡å¥½æµ‹è¯•ã€‚</p>
            <p>è¯·ç­‰å¾…Ownerå¯åŠ¨æµ‹è¯•ï¼Œæˆ–è”ç³»Ownerç¡®è®¤æµ‹è¯•çŠ¶æ€ã€‚</p>
            <div class="status-info">
                <p><strong>å½“å‰çŠ¶æ€:</strong> ç­‰å¾…Ownerå‡†å¤‡æµ‹è¯•</p>
                <p><strong>å»ºè®®:</strong> è¯·ç¨åå†è¯•ï¼Œæˆ–è”ç³»æµ‹è¯•ç®¡ç†å‘˜</p>
            </div>
            <button onclick="logout()" class="back-btn">è¿”å›ç™»å½•</button>
            <button onclick="checkForActiveSession()" class="refresh-btn">åˆ·æ–°æ£€æŸ¥</button>
        </div>
    </div>

    <!-- ä¸Šä¼ æ¨¡æ€æ¡† -->
    <div id="uploadModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeUploadModal()">&times;</span>
            <h2>ä¸Šä¼ æ–°Quiz</h2>
            
            <div class="upload-form">
                <div class="form-group">
                    <label for="zipFile">é€‰æ‹©QuizåŒ… (å‹ç¼©æ–‡ä»¶):</label>
                    <input type="file" id="zipFile" accept=".zip,.7z,.gz,.tar.gz,.tgz" required>
                    <small>å‹ç¼©åŒ…åº”åŒ…å«: quiz.csv å’Œ images/ æ–‡ä»¶å¤¹</small>
                </div>
                
                <div class="form-group">
                    <label for="quizName">Quizåç§°:</label>
                    <input type="text" id="quizName" placeholder="è¾“å…¥Quizåç§°" required>
                </div>
                
                <div class="form-group">
                    <button onclick="uploadQuizPackage()" class="upload-btn">ä¸Šä¼ </button>
                    <button onclick="closeUploadModal()" class="cancel-btn">å–æ¶ˆ</button>
                </div>
                
                <div id="uploadProgress"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        import { getStorage } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCT4VCPw8QoBrQ3H5VhLDMG7kudyEx_H_w",
            authDomain: "q-and-a-generator.firebaseapp.com",
            projectId: "q-and-a-generator",
            storageBucket: "q-and-a-generator.firebasestorage.app",
            messagingSenderId: "1009574042925",
            appId: "1:1009574042925:web:a9c885ba6a6aec3ac087a4"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // Export to global scope
        window.db = db;
        window.storage = storage;
        window.firebaseApp = app;
        
        console.log('Firebase initialized successfully');
        
        // Update debug status
        document.getElementById('firebaseStatus').textContent = 'Firebase: âœ… Connected';
        
        // Test basic Firebase functionality
        window.testBasicFunctionality = async function() {
            const statusEl = document.getElementById('clientStatus');
            statusEl.textContent = 'Testing...';
            
            try {
                // Test 1: Check if db exists
                if (!window.db) {
                    throw new Error('Firebase DB not available');
                }
                
                // Test 2: Check if client.js functions exist
                if (!window.initializeClientInterface) {
                    throw new Error('Client interface functions not loaded');
                }
                
                // Test 3: Check if DOM elements exist
                const questionsContainer = document.getElementById('questionsContainer');
                if (!questionsContainer) {
                    throw new Error('Questions container not found');
                }
                
                // Test 4: Try to query Firebase
                const { collection, getDocs, limit, query } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js');
                const testQuery = query(collection(window.db, 'sessions'), limit(1));
                const testSnapshot = await getDocs(testQuery);
                
                statusEl.textContent = `âœ… All tests passed! Sessions: ${testSnapshot.docs.length}`;
                console.log('ğŸ”´ DEBUG: All basic functionality tests passed');
                
            } catch (error) {
                statusEl.textContent = `âŒ Error: ${error.message}`;
                console.error('ğŸ”´ DEBUG: Test failed:', error);
            }
        };
    </script>
    
    <script src="js/firebase_service.js"></script>
    <script src="js/quiz_upload.js"></script>
    <script src="js/owner_service.js"></script>
    <script src="js/common.js"></script>
    <script src="js/owner.js"></script>
    <script src="js/client.js"></script>
    
    <script>
        // ä¸»åº”ç”¨é€»è¾‘
        let currentUser = '';
        let currentUserRole = '';
        
        // ç™»å½•å‡½æ•°
        async function login() {
            const userName = document.getElementById('userName').value.trim();
            if (!userName) {
                alert('Please enter your name.');
                return;
            }
            currentUser = userName;
            sessionStorage.setItem('userName', userName);
            // æ£€æŸ¥æ˜¯å¦ä¸ºOwner
            const isOwner = isValidOwner(userName);
            if (isOwner) {
                currentUserRole = 'owner';
                // Authenticate with owner service
                if (window.ownerService) {
                    const owner = window.ownerService.authenticateOwner(userName);
                    if (owner) {
                        console.log(`Welcome, ${owner.displayName}! Role: ${owner.role}`);
                    }
                }
                showOwnerDashboard();
            } else {
                currentUserRole = 'client';
                // æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒsession
                const activeSession = await window.firebaseService.getActiveSession();
                if (activeSession) {
                    showClientInterface();
                } else {
                    show404Page();
                }
            }
        }
        
        // æ˜¾ç¤ºOwner Dashboard
        function showOwnerDashboard() {
            hideAllInterfaces();
            document.getElementById('ownerDashboard').style.display = 'block';
            
            // Display owner information
            if (window.ownerService) {
                const owner = window.ownerService.getCurrentOwner();
                if (owner) {
                    document.getElementById('ownerName').textContent = `${owner.displayName} (${owner.role})`;
                } else {
                    document.getElementById('ownerName').textContent = currentUser;
                }
            } else {
                document.getElementById('ownerName').textContent = currentUser;
            }
            
            // åˆå§‹åŒ–Owner Dashboard
            if (typeof initializeOwnerDashboard === 'function') {
                initializeOwnerDashboard();
            }
        }
        
        // æ˜¾ç¤ºClient Interface
        function showClientInterface() {
            hideAllInterfaces();
            document.getElementById('clientInterface').style.display = 'block';
            document.getElementById('clientName').textContent = currentUser;
            
            // åˆå§‹åŒ–Client Interface
            if (typeof initializeClientInterface === 'function') {
                initializeClientInterface();
            }
        }
        
        // æ˜¾ç¤º404é¡µé¢
        function show404Page() {
            hideAllInterfaces();
            document.getElementById('notFoundInterface').style.display = 'block';
        }
        
        // éšè—æ‰€æœ‰ç•Œé¢
        function hideAllInterfaces() {
            document.getElementById('loginInterface').style.display = 'none';
            document.getElementById('ownerDashboard').style.display = 'none';
            document.getElementById('clientInterface').style.display = 'none';
            document.getElementById('notFoundInterface').style.display = 'none';
        }
        
        // ç™»å‡ºå‡½æ•°
        function logout() {
            // Logout from owner service if available
            if (window.ownerService) {
                window.ownerService.logout();
            }
            
            sessionStorage.removeItem('userName');
            currentUser = '';
            currentUserRole = '';
            showLogin();
        }
        
        // æ˜¾ç¤ºç™»å½•é¡µé¢
        function showLogin() {
            hideAllInterfaces();
            document.getElementById('loginInterface').style.display = 'block';
        }
        
        // æ£€æŸ¥æ´»è·ƒsession
        async function checkForActiveSession() {
            const activeSession = await window.firebaseService.getActiveSession();
            if (activeSession) {
                showClientInterface();
            }
        }
        
        // å…è®¸Enteré”®ç™»å½•
        document.getElementById('userName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç°æœ‰session
        window.addEventListener('load', function() {
            const savedUser = sessionStorage.getItem('userName');
            if (savedUser) {
                currentUser = savedUser;
                login();
            }
        });
    </script>
</body>
</html> 